{% extends "base_arena.html" %}

{% block title %}Draft Lobby - ManaForge{% endblock %}

{% block content %}
<div class="py-12 px-4">
    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-12">
            <h1 class="font-magic text-4xl md:text-5xl font-bold text-arena-accent mb-4">
                &#x1F4E6; Draft Lobby
            </h1>
            <p class="text-xl text-arena-text-dim">
                Create or join a draft to build your deck.
            </p>
        </div>

        <div class="arena-card rounded-xl mb-8">
            <div class="p-8">
                <h2 class="font-magic text-3xl font-bold text-arena-accent mb-2 text-center">Create a Draft Room</h2>
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="relative">
                        <input
                            type="text"
                            id="roomName"
                            placeholder="Enter Draft Room Name..."
                            value=""
                            class="w-full px-6 py-4 bg-arena-surface border border-arena-accent/30 rounded-lg text-arena-text placeholder-arena-text-muted focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none transition-all duration-200 text-center text-lg font-semibold"
                        >
                        <button
                            onclick="generateRandomRoomName()"
                            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-arena-accent hover:text-arena-accent-bright transition-colors"
                            title="Generate random name"
                        >
                            ðŸŽ²
                        </button>
                    </div>
                    <div>
                        <label for="setName" class="block text-arena-text-dim mb-2">Set Name</label>
                        <input type="text" id="setName" placeholder="Search for a set (e.g., Dominaria United)" class="w-full px-6 py-4 bg-arena-surface border border-arena-accent/30 rounded-lg text-arena-text placeholder-arena-text-muted focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none transition-all duration-200">
                        <div id="set-suggestions" class="mt-2"></div>
                    </div>
                    <input type="hidden" id="setCode">
                    <input type="hidden" id="setFullName">
                    <button onclick="createDraftRoom()" class="arena-button w-full py-4 px-8 rounded-lg font-semibold text-xl transition-all duration-300 group">
                        Create Room
                    </button>
                </div>
            </div>
        </div>

        <div class="arena-card rounded-xl">
            <div class="p-8">
                <h2 class="font-magic text-3xl font-bold text-arena-accent mb-2 text-center">Join a Draft Room</h2>
                <div id="draft-room-list" class="space-y-4">
                    <!-- Draft rooms will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let setInput;
    let suggestionsDiv;
    let setCodeInput;
    let setFullNameInput;
    let allSets = [];
    let isLoadingSets = false;

    async function ensureSetsLoaded() {
        if (allSets.length || isLoadingSets) {
            return allSets;
        }

        isLoadingSets = true;
        try {
            const response = await fetch('/api/v1/draft/sets');
            if (!response.ok) {
                allSets = [];
                return allSets;
            }

            allSets = await response.json();
            return allSets;
        } catch (error) {
            allSets = [];
            return allSets;
        } finally {
            isLoadingSets = false;
        }
    }

    function renderLoadingSets() {
        if (!suggestionsDiv) {
            return;
        }

        suggestionsDiv.innerHTML = `
            <div class="p-4 text-center text-arena-text-muted text-sm">
                Loading sets...
            </div>
        `;
    }

    function renderSetSuggestions(sets) {
        if (!suggestionsDiv) {
            return;
        }

        if (!sets.length) {
            suggestionsDiv.innerHTML = `
                <div class="p-4 text-center text-arena-text-muted text-sm">
                    No sets found.
                </div>
            `;
            return;
        }

        suggestionsDiv.innerHTML = `
            <div class="max-h-72 overflow-y-auto border border-arena-accent/20 rounded-lg divide-y divide-arena-accent/10 bg-arena-surface/90 backdrop-blur">
                ${sets.map(set => `
                    <button
                        type="button"
                        class="w-full flex items-center justify-between px-4 py-3 hover:bg-arena-surface transition-colors text-left"
                        data-code="${set.code ?? ''}"
                        data-name="${encodeURIComponent(set.name ?? '')}"
                    >
                        <div class="flex items-center gap-3">
                            ${set.icon_svg_uri ? `<img src="${set.icon_svg_uri}" alt="${String(set.code ?? '').toUpperCase()} icon" class="w-8 h-8">` : `<div class="w-8 h-8 rounded-full bg-arena-accent/20"></div>`}
                            <div>
                                <p class="font-semibold text-sm md:text-base text-arena-text">${set.name ?? 'Unknown Set'}</p>
                                <p class="text-xs text-arena-text-muted uppercase tracking-wide">${String(set.code ?? '').toUpperCase()}</p>
                            </div>
                        </div>
                        <span class="text-xs text-arena-text-muted">${set.released_at ?? 'TBD'}</span>
                    </button>
                `).join('')}
            </div>
        `;
    }

    function hideSetSuggestions() {
        if (suggestionsDiv) {
            suggestionsDiv.innerHTML = '';
        }
    }

    function getFilteredSets(term) {
        if (!term) {
            return allSets;
        }

        const normalized = term.toLowerCase();
        return allSets.filter(set =>
            (set.name ?? '').toLowerCase().includes(normalized) ||
            (set.code ?? '').toLowerCase().includes(normalized)
        );
    }

    async function showSetSuggestions() {
        if (!setInput) {
            return;
        }

        if (!allSets.length) {
            renderLoadingSets();
            await ensureSetsLoaded();
        }

        const filtered = getFilteredSets(setInput.value.trim());
        renderSetSuggestions(filtered);
    }

    async function handleSetInput() {
        if (!setInput) {
            return;
        }

        if (!allSets.length) {
            renderLoadingSets();
            await ensureSetsLoaded();
        }

        const filtered = getFilteredSets(setInput.value.trim());
        renderSetSuggestions(filtered);
    }

    function selectSet(code, name) {
        if (!setInput || !setCodeInput || !setFullNameInput) {
            return;
        }

        setInput.value = name;
        setCodeInput.value = code;
        setFullNameInput.value = name;
        hideSetSuggestions();
    }

    async function createDraftRoom() {
        const roomName = document.getElementById('roomName').value;
        const setCode = setCodeInput ? setCodeInput.value : document.getElementById('setCode').value;
        const setFullName = setFullNameInput ? setFullNameInput.value : document.getElementById('setFullName').value;

        if (!setCode) {
            alert('Please select a set.');
            return;
        }

        const creatorId = `player-${Math.random().toString(36).substr(2, 9)}`;

        const response = await fetch('/api/v1/draft/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: roomName,
                set_code: setCode,
                set_name: setFullName,
                creator_id: creatorId
            })
        });

        if (response.ok) {
            const room = await response.json();
            window.location.href = `/draft/${room.id}?player=${creatorId}`;
        } else {
            alert('Failed to create draft room.');
        }
    }

    async function loadDraftRooms() {
        const response = await fetch('/api/v1/draft/rooms');
        const rooms = await response.json();
        const listDiv = document.getElementById('draft-room-list');
        if (rooms.length === 0) {
            listDiv.innerHTML = `<p class="text-center text-arena-text-dim">No active draft rooms found.</p>`;
            return;
        }
        listDiv.innerHTML = rooms.map(room => `
            <div class="p-4 bg-arena-surface rounded-lg flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg">${room.name}</h3>
                    <p class="text-sm text-arena-text-dim">${room.set_name} - ${room.players.length}/${room.max_players} players</p>
                </div>
                <button onclick="joinDraftRoom('${room.id}')" class="arena-button px-4 py-2 rounded-lg">Join</button>
            </div>
        `).join('');
    }

    async function joinDraftRoom(roomId) {
        const playerId = `player-${Math.random().toString(36).substr(2, 9)}`;
        const response = await fetch(`/api/v1/draft/rooms/${roomId}/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_id: playerId })
        });

        if (response.ok) {
            window.location.href = `/draft/${roomId}?player=${playerId}`;
        } else {
            alert('Failed to join draft room. It might be full or already started.');
        }
    }

    function generateRandomRoomName() {
        const ADJECTIVES = ["Mystic", "Arcane", "Forbidden", "Ancient", "Cosmic", "Shadowy", "Radiant", "Eternal"];
        const NOUNS = ["Nexus", "Crucible", "Sanctum", "Rift", "Spire", "Obelisk", "Chamber", "Gauntlet"];

        const randomAdjective = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
        const randomNoun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
        const randomNumber = Math.floor(Math.random() * 999) + 1;

        const randomName = `${randomAdjective}-${randomNoun}-${randomNumber}`;
        document.getElementById('roomName').value = randomName;
    }

    function initializeSetSelection() {
        setInput = document.getElementById('setName');
        suggestionsDiv = document.getElementById('set-suggestions');
        setCodeInput = document.getElementById('setCode');
        setFullNameInput = document.getElementById('setFullName');

        if (!setInput || !suggestionsDiv) {
            return;
        }

        setInput.addEventListener('focus', showSetSuggestions);
        setInput.addEventListener('input', handleSetInput);

        suggestionsDiv.addEventListener('click', (event) => {
            const targetButton = event.target.closest('button[data-code]');
            if (!targetButton) {
                return;
            }

            const code = targetButton.dataset.code ?? '';
            const name = targetButton.dataset.name ? decodeURIComponent(targetButton.dataset.name) : '';
            selectSet(code, name);
        });

        document.addEventListener('click', (event) => {
            if (!setInput || !suggestionsDiv) {
                return;
            }

            if (event.target === setInput || suggestionsDiv.contains(event.target)) {
                return;
            }

            hideSetSuggestions();
        });
    }

    window.addEventListener('load', () => {
        initializeSetSelection();
        loadDraftRooms();
        generateRandomRoomName();
    });
</script>
{% endblock %}
