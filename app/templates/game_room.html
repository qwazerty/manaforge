{% extends "base_arena.html" %}

{% block title %}{{ title }}{% endblock %}

{% set player_status = setup['player_status'] %}
{% set player1 = player_status.get('player1') %}
{% set player2 = player_status.get('player2') %}
{% set player1_name = player1['player_name'] if player1 and player1['player_name'] else 'Player 1' %}
{% set player2_name = player2['player_name'] if player2 and player2['player_name'] else 'Player 2' %}
{% block content %}
<div id="game-setup-root" class="py-12 px-4">
    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Room Overview -->
        <div class="arena-card rounded-xl p-8 space-y-6 animate-slide-up">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
                <div class="space-y-3">
                    <h1 class="font-magic text-3xl md:text-4xl font-bold text-arena-accent">‚öôÔ∏è Duel Preparation</h1>
                    <p class="text-arena-text text-lg">
                        Preparing battlefield <span class="text-arena-accent font-semibold">{{ game_id }}</span>
                    </p>
                    <p id="setup-overall-status" class="text-arena-text-dim">
                        {{ setup['status'] }}
                    </p>
                    <p id="room-seat-summary" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-arena-surface-light text-sm text-arena-text-dim border border-arena-accent/20">
                        Seats:
                        <span class="font-semibold text-arena-accent">
                            ‚Äî
                        </span>
                    </p>
                    <p id="setup-progress-pill" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-arena-surface-light text-sm text-arena-text-dim border border-arena-accent/20">
                        Deck submissions: 
                        <span class="font-semibold text-arena-accent">
                            {{ (1 if player1 and player1['submitted'] else 0) + (1 if player2 and player2['submitted'] else 0) }} / 2
                        </span>
                    </p>
                    <p id="setup-last-update" class="text-xs text-arena-muted">
                        Last update: just now
                    </p>
                </div>

                <div class="w-full md:w-80 space-y-4">
                    <div class="bg-arena-surface/80 border border-arena-accent/20 rounded-lg p-4">
                        <p class="text-sm text-arena-muted uppercase tracking-wide mb-3">Share Room Links</p>
                        <div class="space-y-3 text-sm">
                            <div class="flex flex-col gap-2">
                                <label class="text-arena-text-dim font-medium">Player 1</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" readonly class="flex-1 bg-arena-surface-light border border-arena-accent/20 rounded px-3 py-2 text-xs text-arena-text truncate focus:outline-none" value="{{ share_links['player1'] }}">
                                    <button type="button" class="arena-button rounded-lg px-3 py-2 text-xs font-semibold transition-all duration-200" data-copy-role="player1">Copy</button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-arena-text-dim font-medium">Player 2</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" readonly class="flex-1 bg-arena-surface-light border border-arena-accent/20 rounded px-3 py-2 text-xs text-arena-text truncate focus:outline-none" value="{{ share_links['player2'] }}">
                                    <button type="button" class="arena-button rounded-lg px-3 py-2 text-xs font-semibold transition-all duration-200" data-copy-role="player2">Copy</button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-arena-text-dim font-medium">Spectator</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" readonly class="flex-1 bg-arena-surface-light border border-arena-accent/20 rounded px-3 py-2 text-xs text-arena-text truncate focus:outline-none" value="{{ share_links['spectator'] }}">
                                    <button type="button" class="arena-button rounded-lg px-3 py-2 text-xs font-semibold transition-all duration-200" data-copy-role="spectator">Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="copy-status-message" class="text-xs text-arena-muted"></div>
                </div>
            </div>

            <div class="grid gap-4 text-sm text-arena-text-dim md:grid-cols-3">
                <div class="flex items-center gap-3 bg-arena-surface-light rounded-lg px-4 py-3 border border-arena-accent/10">
                    <span class="text-xl">üéØ</span>
                    <div class="flex-1">
                        <label for="game-format-select" class="text-arena-text font-semibold block mb-1">Game Format</label>
                        <select id="game-format-select" class="w-full bg-arena-surface border border-arena-accent/30 rounded px-2 py-1 text-arena-text text-sm focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none">
                            <option value="standard" {% if setup['game_format'] == 'standard' %}selected{% endif %}>Standard</option>
                            <option value="modern" {% if setup['game_format'] == 'modern' %}selected{% endif %}>Modern</option>
                            <option value="pioneer" {% if setup['game_format'] == 'pioneer' %}selected{% endif %}>Pioneer</option>
                            <option value="pauper" {% if setup['game_format'] == 'pauper' %}selected{% endif %}>Pauper</option>
                            <option value="legacy" {% if setup['game_format'] == 'legacy' %}selected{% endif %}>Legacy</option>
                            <option value="vintage" {% if setup['game_format'] == 'vintage' %}selected{% endif %}>Vintage</option>
                            <option value="duel_commander" {% if setup['game_format'] == 'duel_commander' %}selected{% endif %}>Duel Commander</option>
                            <option value="commander_multi" {% if setup['game_format'] == 'commander_multi' %}selected{% endif %}>Commander Multi</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-arena-surface-light rounded-lg px-4 py-3 border border-arena-accent/10">
                    <span class="text-xl">‚è±Ô∏è</span>
                    <div class="flex-1">
                        <label for="phase-mode-select" class="text-arena-text font-semibold block mb-1">Phase Mode</label>
                        <select id="phase-mode-select" class="w-full bg-arena-surface border border-arena-accent/30 rounded px-2 py-1 text-arena-text text-sm focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none">
                            <option value="casual" {% if setup['phase_mode'] == 'casual' %}selected{% endif %}>Casual</option>
                            <option value="strict" {% if setup['phase_mode'] == 'strict' %}selected{% endif %}>Strict</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-arena-surface-light rounded-lg px-4 py-3 border border-arena-accent/10">
                    <span class="text-xl">üõ°Ô∏è</span>
                    <div class="flex-1">
                        <label for="player-role-select" class="text-arena-text font-semibold block mb-1">Your Role</label>
                        <select id="player-role-select" class="w-full bg-arena-surface border border-arena-accent/30 rounded px-2 py-1 text-arena-text text-sm focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none">
                            <option value="player1" {% if player_role == 'player1' %}selected{% endif %}>Player 1</option>
                            <option value="player2" {% if player_role == 'player2' %}selected{% endif %}>Player 2</option>
                            <option value="spectator" {% if player_role == 'spectator' %}selected{% endif %}>Spectator</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Status Grid -->
        <div class="grid gap-6 md:grid-cols-2">
            <div id="player-status-player1" class="arena-card rounded-xl p-6 space-y-4 border border-arena-accent/20">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <h2
                                class="font-magic text-2xl text-arena-accent mb-1 {% if player_role == 'player1' %}cursor-text hover:text-arena-accent-light transition-colors{% endif %}"
                                data-player="player1"
                                data-field="name"
                                data-name-editable="{{ 'true' if player_role == 'player1' else 'false' }}"
                            >
                                {{ player1_name }}
                            </h2>
                            {% if player_role == 'player1' %}
                            <button
                                type="button"
                                class="text-arena-muted text-sm hover:text-arena-accent transition-colors"
                                title="Cliquez pour renommer"
                                data-name-edit-trigger="player1"
                            >
                                ‚úèÔ∏è
                            </button>
                            {% endif %}
                        </div>
                        <p class="text-sm text-arena-muted">Primary seat</p>
                    </div>
                    <span class="accent-pill border-yellow-500/40 text-yellow-300" data-player="player1" data-field="badge">
                        {% if player1 and player1['validated'] %}
                            Ready
                        {% elif player1 and player1['submitted'] %}
                            Deck Submitted
                        {% elif player1 and player1['seat_claimed'] %}
                            Seated
                        {% else %}
                            Open Seat
                        {% endif %}
                    </span>
                </div>
                <div class="space-y-3 text-sm text-arena-text-dim" data-player="player1" data-field="details">
                    <p>Seat Status: <span class="text-arena-text">{{ 'Occupied' if player1 and player1['seat_claimed'] else 'Available' }}</span></p>
                    <p>Deck Name: <span class="text-arena-text">{{ player1['deck_name'] if player1 and player1['deck_name'] else 'Pending submission' }}</span></p>
                    <p>Card Count: <span class="text-arena-text">{{ player1['card_count'] if player1 and player1['card_count'] else '‚Äî' }}</span></p>
                    <p>Status: <span class="text-arena-text">{{ player1['message'] if player1 and player1['message'] else 'Awaiting player action' }}</span></p>
                </div>
            </div>

            <div id="player-status-player2" class="arena-card rounded-xl p-6 space-y-4 border border-arena-accent/20">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <h2
                                class="font-magic text-2xl text-arena-accent mb-1 {% if player_role == 'player2' %}cursor-text hover:text-arena-accent-light transition-colors{% endif %}"
                                data-player="player2"
                                data-field="name"
                                data-name-editable="{{ 'true' if player_role == 'player2' else 'false' }}"
                            >
                                {{ player2_name }}
                            </h2>
                            {% if player_role == 'player2' %}
                            <button
                                type="button"
                                class="text-arena-muted text-sm hover:text-arena-accent transition-colors"
                                title="Cliquez pour renommer"
                                data-name-edit-trigger="player2"
                            >
                                ‚úèÔ∏è
                            </button>
                            {% endif %}
                        </div>
                        <p class="text-sm text-arena-muted">Challenger seat</p>
                    </div>
                    <span class="accent-pill border-yellow-500/40 text-yellow-300" data-player="player2" data-field="badge">
                        {% if player2 and player2['validated'] %}
                            Ready
                        {% elif player2 and player2['submitted'] %}
                            Deck Submitted
                        {% elif player2 and player2['seat_claimed'] %}
                            Seated
                        {% else %}
                            Open Seat
                        {% endif %}
                    </span>
                </div>
                <div class="space-y-3 text-sm text-arena-text-dim" data-player="player2" data-field="details">
                    <p>Seat Status: <span class="text-arena-text">{{ 'Occupied' if player2 and player2['seat_claimed'] else 'Available' }}</span></p>
                    <p>Deck Name: <span class="text-arena-text">{{ player2['deck_name'] if player2 and player2['deck_name'] else 'Pending submission' }}</span></p>
                    <p>Card Count: <span class="text-arena-text">{{ player2['card_count'] if player2 and player2['card_count'] else '‚Äî' }}</span></p>
                    <p>Status: <span class="text-arena-text">{{ player2['message'] if player2 and player2['message'] else 'Awaiting player action' }}</span></p>
                </div>
            </div>
        </div>

        <!-- Deck Submission -->
        <div id="deck-form-section" class="arena-card rounded-xl p-8 space-y-6 border border-arena-accent/20 {% if player_role == 'spectator' %}hidden{% endif %}">
            <div>
                <h2 class="font-magic text-2xl text-arena-accent mb-2">üìö Submit Your Deck</h2>
                <p class="text-arena-text-dim text-sm">
                    Paste your decklist below or import it from a public URL. It will be validated automatically via Scryfall once submitted.
                </p>
            </div>

            <form id="deck-submit-form" class="space-y-4">
                <div class="space-y-2">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <label class="block text-sm font-semibold text-arena-text">Import from Deck Manager</label>
                        <a href="/decks" class="text-xs text-arena-accent hover:underline">Open Deck Library</a>
                    </div>
                    <div id="deck-library-import" class="border border-arena-accent/20 rounded-lg bg-arena-surface/60 p-4 space-y-3">
                        <p id="deck-library-import-empty" class="text-sm text-arena-muted hidden">
                            No saved decks available yet. Visit the Deck Manager to create and save one.
                        </p>
                        <div id="deck-library-import-list" class="space-y-2"></div>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="h-px flex-1 bg-arena-accent/20"></span>
                    <span class="text-xs font-semibold uppercase tracking-wide text-arena-muted">or</span>
                    <span class="h-px flex-1 bg-arena-accent/20"></span>
                </div>

                <div class="space-y-2">
                    <label for="decklistUrl" class="block text-sm font-semibold text-arena-text">Import from URL</label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            type="url"
                            id="decklistUrl"
                            class="flex-1 px-4 py-3 bg-arena-surface border border-arena-accent/30 rounded-lg text-arena-text placeholder:text-arena-muted focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none text-sm"
                            placeholder="https://www.moxfield.com/decks/..."
                            autocomplete="off"
                        />
                        <button type="button" id="deck-import-button" class="arena-button rounded-lg px-5 py-3 text-sm font-semibold transition-all duration-200">
                            Import Deck
                        </button>
                    </div>
                    <p class="text-xs text-arena-muted">
                        Paste a public deck URL from Moxfield, Scryfall, MTGGoldfish, etc. We'll fetch the list automatically.
                    </p>
                </div>

                <div class="flex items-center justify-center gap-2">
                    <span class="h-px flex-1 bg-arena-accent/20"></span>
                    <span class="text-xs font-semibold uppercase tracking-wide text-arena-muted">or</span>
                    <span class="h-px flex-1 bg-arena-accent/20"></span>
                </div>

                <textarea
                    id="decklistText"
                    rows="8"
                    class="w-full px-5 py-4 bg-arena-surface border border-arena-accent/30 rounded-lg text-arena-text placeholder:text-arena-muted focus:border-arena-accent focus:ring-2 focus:ring-arena-accent/20 focus:outline-none font-mono text-sm"
                    placeholder="Paste your decklist here...&#10;Example:&#10;4 Lightning Bolt&#10;4 Grizzly Bears&#10;12 Mountain&#10;12 Forest"
                ></textarea>

                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <p id="opponent-status-msg" class="text-sm text-arena-muted">
                        Awaiting updates from both players...
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" id="deck-preview-button" class="arena-button rounded-lg px-6 py-3 text-sm font-semibold transition-all duration-200">
                            Preview Deck
                        </button>
                        <button type="submit" id="deck-submit-button" class="arena-button rounded-lg px-6 py-3 text-sm font-semibold transition-all duration-200">
                            Submit Deck
                        </button>
                    </div>
                </div>
            </form>

            <div id="deck-submit-status" class="text-sm text-arena-muted"></div>

            <div id="deck-preview" class="hidden space-y-3 border border-arena-accent/20 rounded-lg bg-arena-surface/60 p-4">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-arena-accent">Deck Preview</h3>
                    <span id="deck-preview-count" class="text-xs text-arena-muted"></span>
                </div>
                <div id="deck-preview-cards" class="grid gap-2 md:grid-cols-2 text-sm max-h-56 overflow-y-auto pr-2"></div>
            </div>

            <div class="p-4 rounded-lg bg-arena-surface/60 border border-dashed border-arena-accent/20 space-y-3">
                <div class="flex items-start gap-3">
                    <span class="text-xl">ü™Ñ</span>
                    <div>
                        <p class="text-sm text-arena-text">
                            Need a quick Modern showdown? Auto-import the top two paper decks from MTGGoldfish and start immediately.
                        </p>
                        <p class="text-xs text-arena-muted">
                            Source: <a href="https://www.mtggoldfish.com/metagame/modern#paper" class="underline hover:text-arena-accent" target="_blank" rel="noopener">MTGGoldfish Modern metagame</a>.
                        </p>
                    </div>
                </div>
                <button
                    type="button"
                    id="modern-example-button"
                    class="arena-button w-full sm:w-auto px-5 py-3 rounded-lg font-semibold text-sm transition-all duration-200"
                >
                    Import Modern Deck Example
                </button>
                <p class="text-xs text-arena-muted">
                    Imports decks for both seats in this room. Only works before other decks are submitted.
                </p>
            </div>
        </div>

        <!-- Spectator Guidance -->
        <div id="spectator-message" class="arena-card rounded-xl p-6 border border-arena-accent/20 {% if player_role != 'spectator' %}hidden{% endif %}">
            <div class="flex items-start gap-3">
                <span class="text-2xl">üëÄ</span>
                <div>
                    <h3 class="font-magic text-xl text-arena-accent mb-1">Spectator Mode</h3>
                    <p class="text-sm text-arena-text-dim">
                        Both seats are already taken. Feel free to stay on this page to monitor preparation or jump directly to the battlefield once decks are validated.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.gameRoomConfig = {{ {
    "gameId": game_id,
    "playerRole": player_role,
    "setupApiUrl": setup_api_url,
    "submitApiUrl": submit_api_url,
    "gameInterfaceUrl": game_interface_url,
    "initialStatus": setup,
    "shareLinks": share_links
} | tojson }};
</script>
<script src="{{ url_for('static', path='js/deck-library.js') }}"></script>
<script src="{{ url_for('static', path='js/game-room.js') }}"></script>
{% endblock %}
