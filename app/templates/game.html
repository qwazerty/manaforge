{% extends "base_arena.html" %}

{% block title %}ManaForge - Game Arena{% endblock %}

{% block extra_css %}
<!-- External CSS for game-specific styles -->
<link rel="stylesheet" href="{{ url_for('static', path='css/game-main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='css/game-card-actions.css') }}">
{% endblock %}

{% block content %}
<div x-data="gameInterface()" class="min-h-screen bg-arena-gradient relative">
    <!-- Notification area -->
    <div id="notification-area" class="fixed top-4 right-4 z-50"></div>
    
    <!-- Game Header -->
    <div class="bg-gradient-to-r from-arena-primary/20 to-arena-secondary/20 border-b border-arena-accent/30 p-4">
        <div class="max-w-[1600px] mx-auto flex items-center justify-center">
            <h1 class="font-magic text-3xl font-bold text-arena-accent">‚öîÔ∏è ManaForge Arena</h1>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto px-4 py-6">
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
            <!-- Stack Area (Left Sidebar) -->
            <div class="xl:col-span-1" id="stack-area">
                <!-- Stack content will be generated by JavaScript -->
            </div>
            
            <!-- Main Game Area -->
            <div class="xl:col-span-3" id="game-board">
                <!-- Dynamic content will be generated by JavaScript -->
            </div>

            <!-- Game Controls Sidebar -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Player Role Display (Read-only) -->
                <div class="arena-card rounded-xl p-6">
                    <h4 class="font-magic font-semibold mb-4 text-arena-accent flex items-center">
                        <span class="mr-2">üë§</span>Your Role
                    </h4>
                    <div class="text-center">
                        <div id="current-role-display" class="px-4 py-3 rounded-lg border-2 mb-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="text-sm text-arena-text-dim">
                            <span id="role-description"><!-- Will be populated by JavaScript --></span>
                            </div>
                        <div class="text-xs text-arena-text-muted mt-2">
                            üí° Role was selected in the lobby
                        </div>
                </div>
            </div>

                <!-- Action Panel -->
                <div id="action-panel" class="arena-card rounded-xl p-6 mb-6">
                    <!-- Dynamic content will be generated by JavaScript -->
                </div>

                <!-- Deck, Exile & Graveyard Zone -->
                <div class="arena-card rounded-xl p-6">
                    <h4 class="font-magic font-semibold mb-6 text-arena-accent flex items-center">
                        <span class="mr-2">üìö</span>Card Zones
                    </h4>
                    <div class="space-y-8">
                        <!-- Deck -->
                        <div class="p-3 rounded-lg bg-arena-surface/50 border border-arena-accent/20 hover:border-arena-accent/40 transition-colors" 
                             onclick="showZoneModal('deck')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-semibold text-arena-text text-lg">Deck</div>
                                <div id="deck-count" class="bg-arena-primary text-white px-3 py-1 rounded-full text-sm font-semibold">
                                    60
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <div class="zone-preview-container" id="deck-preview-container">
                                    <div id="deck-top-card" class="zone-card-preview deck-preview" onclick="GameActions.drawCard(); event.stopPropagation();" title="Click to draw a card">
                                        <div class="deck-stack">
                                            <div class="deck-card-layer" style="transform: translateY(4px) translateX(2px)">
                                                <div class="card-back-mini"></div>
                                            </div>
                                            <div class="deck-card-layer" style="transform: translateY(8px) translateX(4px)">
                                                <div class="card-back-mini"></div>
                                            </div>
                                            <div class="deck-top-card">
                                                <div class="card-back-mini"></div>
                                            </div>
                                        </div>
                                        <div class="deck-click-overlay">
                                            <span class="draw-hint">Draw</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exile -->
                        <div class="p-3 rounded-lg bg-arena-surface/50 border border-arena-accent/20 hover:border-arena-accent/40 transition-colors" 
                             onclick="showZoneModal('exile')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-semibold text-arena-text text-lg">Exile</div>
                                <div id="exile-count" class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                    0
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <div class="zone-preview-container" id="exile-preview-container">
                                    <div id="exile-top-card" class="zone-card-preview exile-preview">
                                        <!-- Sera mis √† jour par le JavaScript avec la premi√®re carte exil√©e -->
                                        <div class="card-fallback text-xs">
                                            <span class="text-2xl mb-2">üåå</span>
                                            <div>Empty</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Graveyard -->
                        <div class="p-3 rounded-lg bg-arena-surface/50 border border-arena-accent/20 hover:border-arena-accent/40 transition-colors" 
                             onclick="showZoneModal('graveyard')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-semibold text-arena-text text-lg">Graveyard</div>
                                <div id="graveyard-count" class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                    0
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <div class="zone-preview-container" id="graveyard-preview-container">
                                    <div id="graveyard-top-card" class="zone-card-preview graveyard-preview">
                                        <!-- Sera mis √† jour par le JavaScript avec la derni√®re carte du cimeti√®re -->
                                        <div class="card-fallback text-xs">
                                            <span class="text-2xl mb-2">‚ö∞Ô∏è</span>
                                            <div>Empty</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Section -->
<div class="fixed bottom-0 right-0 w-80 h-96 bg-arena-surface border-l border-t border-arena-accent/30 flex flex-col z-40" 
     x-data="{ chatOpen: false }" 
     :class="{ 'translate-x-full': !chatOpen }">
    
    <!-- Chat Toggle Button -->
    <button @click="chatOpen = !chatOpen" 
            class="absolute -left-12 top-4 bg-arena-primary hover:bg-arena-secondary text-white p-3 rounded-l-lg transition-colors">
        <span x-text="chatOpen ? '‚úï' : 'üí¨'"></span>
    </button>
    
    <!-- Chat Header -->
    <div class="bg-arena-primary/80 p-4 border-b border-arena-accent/30">
        <h3 class="font-magic font-semibold text-arena-accent flex items-center">
            <span class="mr-2">üí¨</span>Battle Chat
        </h3>
    </div>
    
    <!-- Chat Messages -->
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-2 text-sm">
        <div class="text-arena-text-dim text-center py-4">
            <span class="text-2xl block mb-2">‚öîÔ∏è</span>
            <p>Battle chat ready</p>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="p-4 border-t border-arena-accent/30">
        <form onsubmit="sendChatMessage(event)" class="flex gap-2">
            <input type="text" 
                   id="chat-input" 
                   placeholder="Type your message..." 
                   class="flex-1 bg-arena-surface border border-arena-accent/30 rounded px-3 py-2 text-arena-text focus:border-arena-accent focus:outline-none">
            <button type="submit" 
                    class="bg-arena-primary hover:bg-arena-secondary text-white px-4 py-2 rounded font-semibold transition-colors">
                Send
            </button>
        </form>
    </div>
</div>

<!-- External JavaScript modules for game logic -->
<script src="{{ url_for('static', path='js/game-utils.js') }}"></script>
<script src="{{ url_for('static', path='js/game-cards.js') }}"></script>

<!-- UI Module Dependencies (load before main game-ui.js) -->
<script src="{{ url_for('static', path='js/ui/ui-templates.js') }}"></script>
<script src="{{ url_for('static', path='js/ui/ui-notifications.js') }}"></script>
<script src="{{ url_for('static', path='js/ui/zone-manager.js') }}"></script>
<script src="{{ url_for('static', path='js/ui/ui-renderers.js') }}"></script>

<!-- Main UI orchestrator (depends on above modules) -->
<script src="{{ url_for('static', path='js/game-ui.js') }}"></script>

<script src="{{ url_for('static', path='js/game-socket.js') }}"></script>
<script src="{{ url_for('static', path='js/game-actions.js') }}"></script>
<script src="{{ url_for('static', path='js/game-core.js') }}"></script>
<script src="{{ url_for('static', path='js/game-main.js') }}"></script>

<!-- Initialize game with server data -->
<script>
// Pass server data to our external JavaScript
window.gameData = {
    game: {{ game|tojson }},
    gameId: '{{ game.id }}'
};

// The game will be initialized automatically by game-main.js
</script>
{% endblock %}
