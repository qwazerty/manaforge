{% extends "base_arena.html" %}

{% block title %}ManaForge - Game Arena{% endblock %}

{% block head %}
<style>
    /* Player selection styles */
    .player-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
    }
    
    .player-btn {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid transparent;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    
    .player-btn.player1 {
        background: rgba(34, 197, 94, 0.2);
        color: rgb(34, 197, 94);
        border-color: rgba(34, 197, 94, 0.3);
    }
    
    .player-btn.player1.active {
        background: rgba(34, 197, 94, 0.4);
        border-color: rgb(34, 197, 94);
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    
    .player-btn.player2 {
        background: rgba(239, 68, 68, 0.2);
        color: rgb(239, 68, 68);
        border-color: rgba(239, 68, 68, 0.3);
    }
    
    .player-btn.player2.active {
        background: rgba(239, 68, 68, 0.4);
        border-color: rgb(239, 68, 68);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }
    
    .player-btn.spectator {
        background: rgba(147, 51, 234, 0.2);
        color: rgb(147, 51, 234);
        border-color: rgba(147, 51, 234, 0.3);
    }
    
    .player-btn.spectator.active {
        background: rgba(147, 51, 234, 0.4);
        border-color: rgb(147, 51, 234);
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div x-data="gameInterface()" class="min-h-screen bg-arena-gradient relative">
    <!-- Notification area -->
    <div id="notification-area" class="fixed top-4 right-4 z-50"></div>
    
    <!-- Game Turn Header -->
    <div class="bg-gradient-to-r from-arena-primary/20 to-arena-secondary/20 border-b border-arena-accent/30 p-4">
        <div class="max-w-[1600px] mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="font-magic text-3xl font-bold text-arena-accent">‚öîÔ∏è Arena Duel</h1>
                <div class="flex items-center space-x-4">
                    <div class="bg-yellow-500/20 border border-yellow-500/50 px-4 py-2 rounded-lg">
                        <span class="text-yellow-300 font-semibold">Turn {{ game['turn'] }}</span>
                    </div>
                    <div class="bg-blue-500/20 border border-blue-500/50 px-4 py-2 rounded-lg">
                        <span class="text-blue-300 font-semibold">{{ game['phase'] }} Phase</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="font-magic font-semibold">{{ game['players'][game['active_player']]['name'] }}'s Turn</span>
                <div class="w-4 h-4 {{ 'bg-green-500 animate-pulse' if game['active_player'] == 0 else 'bg-red-500 animate-pulse' }} rounded-full"></div>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto px-4 py-6">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Main Game Area -->
            <div class="xl:col-span-3" id="game-board">
                <!-- Dynamic content will be generated by JavaScript -->
            </div>
            
            <!-- Game Controls Sidebar -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Player Role Display (Read-only) -->
                <div class="arena-card rounded-xl p-6">
                    <h4 class="font-magic font-semibold mb-4 text-arena-accent flex items-center">
                        <span class="mr-2">üë§</span>Your Role
                    </h4>
                    <div class="text-center">
                        <div id="current-role-display" class="px-4 py-3 rounded-lg border-2 mb-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="text-sm text-arena-text-dim">
                            <span id="role-description"><!-- Will be populated by JavaScript --></span>
                        </div>
                        <div class="text-xs text-arena-text-muted mt-2">
                            üí° Role was selected in the lobby
                        </div>
                    </div>
                </div>

                <!-- Action Panel -->
                <div id="action-panel" class="arena-card rounded-xl p-6">
                    <!-- Dynamic content will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Section -->
<div class="fixed bottom-0 right-0 w-80 h-96 bg-arena-surface border-l border-t border-arena-accent/30 flex flex-col z-40" 
     x-data="{ chatOpen: false }" 
     :class="{ 'translate-x-full': !chatOpen }">
    
    <!-- Chat Toggle Button -->
    <button @click="chatOpen = !chatOpen" 
            class="absolute -left-12 top-4 bg-arena-primary hover:bg-arena-secondary text-white p-3 rounded-l-lg transition-colors">
        <span x-text="chatOpen ? '‚úï' : 'üí¨'"></span>
    </button>
    
    <!-- Chat Header -->
    <div class="bg-arena-primary/80 p-4 border-b border-arena-accent/30">
        <h3 class="font-magic font-semibold text-arena-accent flex items-center">
            <span class="mr-2">üí¨</span>Battle Chat
        </h3>
    </div>
    
    <!-- Chat Messages -->
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-2 text-sm">
        <div class="text-arena-text-dim text-center py-4">
            <span class="text-2xl block mb-2">‚öîÔ∏è</span>
            <p>Battle chat ready</p>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="p-4 border-t border-arena-accent/30">
        <form onsubmit="sendChatMessage(event)" class="flex gap-2">
            <input type="text" 
                   id="chat-input" 
                   placeholder="Type your message..." 
                   class="flex-1 bg-arena-surface border border-arena-accent/30 rounded px-3 py-2 text-arena-text focus:border-arena-accent focus:outline-none">
            <button type="submit" 
                    class="bg-arena-primary hover:bg-arena-secondary text-white px-4 py-2 rounded font-semibold transition-colors">
                Send
            </button>
        </form>
    </div>
</div>

<script>
// Global variables
let currentSelectedPlayer = 'player1';
let gameState = {{ game|tojson }};
let autoRefreshInterval = null;
let isPageVisible = true;
let websocket = null;
let gameId = '{{ game.id }}';

// URL parameter management
function getPlayerFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const player = urlParams.get('player');
    return ['player1', 'player2', 'spectator'].includes(player) ? player : 'player1';
}

function setPlayerInUrl(playerType) {
    const url = new URL(window.location);
    url.searchParams.set('player', playerType);
    window.history.replaceState({}, '', url);
}

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    // Get player from URL or default to player1
    const playerFromUrl = getPlayerFromUrl();
    currentSelectedPlayer = playerFromUrl;
    
    // Update role display
    updateRoleDisplay();
    
    // Generate dynamic content
    generateGameBoard();
    generateActionPanel();
    
    // Initialize WebSocket connection
    initWebSocket();
    
    // Start auto-refresh as fallback
    startAutoRefresh();
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        isPageVisible = !document.hidden;
        if (isPageVisible) {
            // Resume auto-refresh when page becomes visible
            startAutoRefresh();
            // Reconnect WebSocket if needed
            if (!websocket || websocket.readyState === WebSocket.CLOSED) {
                initWebSocket();
            }
            // Immediate refresh when coming back
            refreshGameData();
        } else {
            // Pause auto-refresh when page is hidden
            stopAutoRefresh();
        }
    });
    
    // Keyboard shortcuts for testing (optional)
    document.addEventListener('keydown', function(e) {
        if (e.key === '1') changePlayer('player1');
        if (e.key === '2') changePlayer('player2');
        if (e.key === '3') changePlayer('spectator');
    });
});

// WebSocket functionality
function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/game/${gameId}?player=${currentSelectedPlayer}`;
    
    try {
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function(event) {
            console.log('WebSocket connected as', currentSelectedPlayer);
            showAutoRefreshIndicator('üîó Connected', 'success');
            
            // Send join notification
            websocket.send(JSON.stringify({
                type: 'player_joined',
                player: currentSelectedPlayer,
                timestamp: Date.now()
            }));
            
            // Request current game state
            requestGameState();
        };
        
        websocket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        };
        
        websocket.onclose = function(event) {
            console.log('WebSocket disconnected');
            showAutoRefreshIndicator('üîå Disconnected', 'warning');
            
            // Attempt to reconnect after a delay
            setTimeout(() => {
                if (isPageVisible) {
                    console.log('Attempting to reconnect WebSocket...');
                    initWebSocket();
                }
            }, 3000);
        };
        
        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            showAutoRefreshIndicator('‚ùå Connection Error', 'error');
        };
        
    } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        showAutoRefreshIndicator('‚ùå WebSocket Init Failed', 'error');
    }
}

function requestGameState() {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
            type: 'request_game_state',
            timestamp: Date.now()
        }));
    }
}

function sendGameAction(actionType, actionData = {}) {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
            type: 'game_action',
            action: actionType,
            data: actionData,
            timestamp: Date.now()
        }));
    } else {
        showNotification('WebSocket not connected', 'error');
    }
}

function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'game_state_update':
            // Update game state from WebSocket
            const newGameState = message.game_state;
            if (JSON.stringify(newGameState) !== JSON.stringify(gameState)) {
                gameState = newGameState;
                generateGameBoard();
                generateActionPanel();
                
                // Show action feedback if provided
                if (message.action_result) {
                    const result = message.action_result;
                    showNotification(`${result.player} performed: ${result.action}`, 'success');
                }
                
                showAutoRefreshIndicator('‚ö° Real-time Update', 'success');
            }
            break;
            
        case 'game_action_start':
            // Show that an action is being processed
            showNotification(`${message.player} is performing: ${message.action}...`, 'success');
            break;
            
        case 'game_action_failed':
            // Show action failure
            showNotification(`Action failed: ${message.error}`, 'error');
            break;
            
        case 'action_error':
            // Handle action errors for current player
            showNotification(`Error: ${message.message}`, 'error');
            break;
            
        case 'chat':
            // Handle chat messages
            addChatMessage(message.player, message.message);
            break;
            
        case 'player_status':
            // Handle player join/leave
            const action = message.action === 'joined' ? 'joined' : 'left';
            showNotification(`${message.player} ${action} (${message.connected_players} connected)`);
            break;
            
        case 'connection_established':
            showNotification(`Connected to game as ${message.player_id} (${message.connected_players} players online)`);
            break;
            
        case 'state_sync':
            // Another player requested state sync
            showAutoRefreshIndicator(`üîÑ Sync by ${message.requested_by}`, 'success');
            break;
            
        case 'ping':
            // Respond to ping with pong
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'pong',
                    timestamp: message.timestamp
                }));
            }
            break;
            
        case 'pong':
            // Handle pong response
            console.log('Received pong from server');
            break;
            
        case 'error':
            // Handle server errors
            showNotification(`Server error: ${message.message}`, 'error');
            break;
            
        default:
            console.log('Unknown WebSocket message:', message);
    }
}

// Enhanced auto-refresh with WebSocket fallback
async function refreshGameData() {
    // First try to request via WebSocket
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
            type: 'request_game_state',
            timestamp: Date.now()
        }));
        return;
    }
    
    // Fallback to HTTP request
    try {
        const response = await fetch(`/api/v1/games/${gameId}/state`);
        if (response.ok) {
            const newGameState = await response.json();
            
            // Check if game state actually changed to avoid unnecessary updates
            if (JSON.stringify(newGameState) !== JSON.stringify(gameState)) {
                gameState = newGameState;
                
                // Regenerate interface with new data
                generateGameBoard();
                generateActionPanel();
                
                // Add subtle visual feedback for updates
                showAutoRefreshIndicator('üîÑ HTTP Update');
            }
        }
    } catch (error) {
        console.error('Auto-refresh error:', error);
        // Don't show error notifications for auto-refresh to avoid spam
    }
}

function showAutoRefreshIndicator(text = 'Updated', type = 'success') {
    const indicator = document.createElement('div');
    
    const colors = {
        'success': 'bg-blue-500/80',
        'warning': 'bg-yellow-500/80',
        'error': 'bg-red-500/80'
    };
    
    indicator.innerHTML = `
        <div class="fixed top-4 left-4 ${colors[type] || colors.success} text-white px-3 py-1 rounded-lg text-sm flex items-center space-x-2 animate-fade-in z-50">
            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span>${text}</span>
        </div>
    `;
    
    document.body.appendChild(indicator);
    
    setTimeout(() => {
        indicator.remove();
    }, 2000);
}

// Enhanced chat functionality
function addChatMessage(player, message) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.innerHTML = `
        <div class="bg-arena-primary/20 border border-arena-accent/30 rounded p-2 animate-fade-in">
            <span class="text-arena-accent font-semibold">${player}:</span>
            <span class="text-arena-text ml-2">${message}</span>
        </div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendChatMessage(event) {
    event.preventDefault();
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message) {
        // Send via WebSocket if available
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({
                type: 'chat',
                player: currentSelectedPlayer === 'spectator' ? 'Spectator' : 'Player ' + currentSelectedPlayer.slice(-1),
                message: message,
                timestamp: Date.now()
            }));
        } else {
            // Fallback to local display
            addChatMessage(currentSelectedPlayer === 'spectator' ? 'Spectator' : 'Player ' + currentSelectedPlayer.slice(-1), message);
        }
        
        input.value = '';
    }
}

// Notification system
function showNotification(message, type = 'success') {
    const notificationArea = document.getElementById('notification-area');
    const notification = document.createElement('div');
    
    const bgColor = type === 'error' ? 'bg-red-500/90' : 'bg-green-500/90';
    const icon = type === 'error' ? '‚ùå' : '‚úÖ';
    
    notification.innerHTML = `
        <div class="${bgColor} text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in">
            <span>${icon}</span>
            <span>${message}</span>
        </div>
    `;
    
    notificationArea.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Alpine.js component for game interface
function gameInterface() {
    return {
        // Component state
    };
}

// Function to update role display
function updateRoleDisplay() {
    const roleDisplay = document.getElementById('current-role-display');
    const roleDescription = document.getElementById('role-description');
    
    if (!roleDisplay || !roleDescription) return;
    
    const roleData = {
        'player1': {
            class: 'bg-green-500/20 border-green-500/50 text-green-400',
            title: 'üõ°Ô∏è Player 1',
            description: 'You control the first player position'
        },
        'player2': {
            class: 'bg-red-500/20 border-red-500/50 text-red-400',
            title: 'üéØ Player 2', 
            description: 'You control the second player position'
        },
        'spectator': {
            class: 'bg-purple-500/20 border-purple-500/50 text-purple-400',
            title: 'üëÅÔ∏è Spectator',
            description: 'You are watching the battle unfold'
        }
    };
    
    const role = roleData[currentSelectedPlayer] || roleData['player1'];
    roleDisplay.className = `px-4 py-3 rounded-lg border-2 mb-3 ${role.class}`;
    roleDisplay.textContent = role.title;
    roleDescription.textContent = role.description;
}

// Function to generate game board
function generateGameBoard() {
    const gameBoardContainer = document.getElementById('game-board');
    if (!gameBoardContainer || !gameState) {
        console.warn('Game board container or game state not found');
        return;
    }
    try {
        const players = gameState.players || [];
        const currentPhase = gameState.phase || 'untap';
        const currentTurn = gameState.turn || 1;
        const activePlayer = gameState.active_player || 0;
        // D√©termination de l'index du joueur contr√¥l√©
        let controlledIdx = 0;
        if (currentSelectedPlayer === 'player2') controlledIdx = 1;
        else if (currentSelectedPlayer === 'player1') controlledIdx = 0;
        // Opposant
        const opponentIdx = controlledIdx === 0 ? 1 : 0;
        gameBoardContainer.innerHTML = `
            <!-- Opponent Area (Player ${opponentIdx + 1}) -->
            <div class="arena-card rounded-xl p-6 mb-6">
                <div class="text-center mb-4">
                    <h3 class="font-magic text-xl font-bold ${opponentIdx === 0 ? 'text-green-400' : 'text-red-400'}">
                        ${players[opponentIdx]?.name || 'Opponent'}
                        ${activePlayer === opponentIdx ? '‚≠ê (Active)' : ''}
                    </h3>
                    <div class="flex justify-center space-x-4 text-sm">
                        <span class="text-red-400">‚ù§Ô∏è ${players[opponentIdx]?.life || 20} Life</span>
                        <span class="text-blue-400">üÉè ${players[opponentIdx]?.hand?.length || 7} Cards</span>
                        <span class="text-gray-400">üìö ${players[opponentIdx]?.library?.length || 53} Library</span>
                    </div>
                </div>
                <!-- Opponent's Battlefield -->
                <div class="bg-arena-surface/50 rounded-lg p-4 mb-4">
                    <h4 class="text-arena-accent font-semibold mb-2">üèüÔ∏è Battlefield</h4>
                    <div class="grid grid-cols-5 gap-2">
                        ${(players[opponentIdx]?.battlefield || []).slice(0, 10).map(card => `
                            <div class="bg-arena-primary/20 border border-arena-accent/30 rounded p-2 text-xs text-center">
                                <div class="font-semibold text-arena-accent">${card.name || 'Unknown'}</div>
                                ${card.power !== undefined && card.toughness !== undefined ? 
                                    `<div class="text-arena-text-dim">${card.power}/${card.toughness}</div>` : 
                                    ''}
                            </div>
                        `).join('') || '<div class="text-arena-text-dim text-center py-4">No permanents</div>'}
                    </div>
                </div>
                <!-- Opponent's Hand (Hidden) -->
                <div class="flex justify-center space-x-1">
                    ${Array(players[opponentIdx]?.hand?.length || 7).fill().map(() => `
                        <div class="w-8 h-12 bg-arena-primary/40 border border-arena-accent/30 rounded"></div>
                    `).join('')}
                </div>
            </div>
            <!-- Battlefield Center -->
            <div class="arena-card rounded-xl p-6 mb-6">
                <div class="text-center">
                    <h3 class="font-magic text-xl font-bold text-arena-accent mb-4">üèüÔ∏è The Battlefield</h3>
                    <!-- Stack -->
                    ${gameState.stack && gameState.stack.length > 0 ? `
                        <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4 mb-4">
                            <h4 class="text-yellow-300 font-semibold mb-2">üìú The Stack</h4>
                            <div class="space-y-2">
                                ${gameState.stack.map(spell => `
                                    <div class="bg-arena-surface rounded p-2 text-sm">
                                        ${spell.name || 'Unknown Spell'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <!-- Game Info -->
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-yellow-500/20 rounded-lg p-3">
                            <div class="text-yellow-300 font-semibold">Turn</div>
                            <div class="text-2xl font-bold">${currentTurn}</div>
                        </div>
                        <div class="bg-blue-500/20 rounded-lg p-3">
                            <div class="text-blue-300 font-semibold">Phase</div>
                            <div class="text-lg font-bold capitalize">${currentPhase}</div>
                        </div>
                        <div class="bg-purple-500/20 rounded-lg p-3">
                            <div class="text-purple-300 font-semibold">Priority</div>
                            <div class="text-lg font-bold">Player ${(gameState.priority_player || 0) + 1}</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Current Player Area -->
            <div class="arena-card rounded-xl p-6">
                <div class="text-center mb-4">
                    <h3 class="font-magic text-xl font-bold ${controlledIdx === 0 ? 'text-green-400' : 'text-red-400'}">
                        ${players[controlledIdx]?.name || 'You'}
                        ${activePlayer === controlledIdx ? '‚≠ê (Active)' : ''}
                    </h3>
                    <div class="flex justify-center space-x-4 text-sm">
                        <span class="text-red-400">‚ù§Ô∏è ${players[controlledIdx]?.life || 20} Life</span>
                        <span class="text-blue-400">üÉè ${players[controlledIdx]?.hand?.length || 7} Cards</span>
                        <span class="text-gray-400">üìö ${players[controlledIdx]?.library?.length || 53} Library</span>
                    </div>
                </div>
                <!-- Your Hand -->
                <div class="bg-arena-surface/50 rounded-lg p-4 mb-4">
                    <h4 class="text-arena-accent font-semibold mb-2">‚úã Your Hand</h4>
                    <div class="flex flex-wrap gap-2">
                        ${(players[controlledIdx]?.hand || []).map((card, index) => `
                            <div class="bg-arena-primary/20 border border-arena-accent/30 rounded p-3 text-xs cursor-pointer hover:bg-arena-primary/40 transition-colors"
                                 onclick="playCardFromHand('${card.id || card.name}', ${index})">
                                <div class="font-semibold text-arena-accent">${card.name || 'Unknown'}</div>
                                <div class="text-arena-text-dim">${card.mana_cost || '0'}</div>
                                <div class="text-arena-text-muted">${card.card_type || 'Unknown'}</div>
                            </div>
                        `).join('') || '<div class="text-arena-text-dim text-center py-4">No cards in hand</div>'}
                    </div>
                </div>
                <!-- Your Battlefield -->
                <div class="bg-arena-surface/50 rounded-lg p-4">
                    <h4 class="text-arena-accent font-semibold mb-2">üèüÔ∏è Your Battlefield</h4>
                    <div class="grid grid-cols-5 gap-2">
                        ${(players[controlledIdx]?.battlefield || []).map(card => `
                            <div class="bg-arena-primary/20 border border-arena-accent/30 rounded p-2 text-xs text-center cursor-pointer hover:bg-arena-primary/40 transition-colors">
                                <div class="font-semibold text-arena-accent">${card.name || 'Unknown'}</div>
                                ${card.power !== undefined && card.toughness !== undefined ? 
                                    `<div class="text-arena-text-dim">${card.power}/${card.toughness}</div>` : 
                                    ''}
                            </div>
                        `).join('') || '<div class="text-arena-text-dim text-center py-4">No permanents</div>'}
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error generating game board:', error);
        gameBoardContainer.innerHTML = `
            <div class="arena-card rounded-xl p-6 text-center">
                <h3 class="text-red-400 font-bold mb-2">‚ö†Ô∏è Error Loading Game Board</h3>
                <p class="text-arena-text-dim">${error.message}</p>
            </div>
        `;
    }
}

// Function to generate action panel
function generateActionPanel() {
    const actionPanelContainer = document.getElementById('action-panel');
    if (!actionPanelContainer || !gameState) {
        console.warn('Action panel container or game state not found');
        return;
    }
    try {
        const isActivePlayer = currentSelectedPlayer !== 'spectator';
        const canAct = isActivePlayer; // Simplified for now
        actionPanelContainer.innerHTML = `
            <h4 class="font-magic font-semibold mb-4 text-arena-accent flex items-center">
                <span class="mr-2">‚ö°</span>Game Actions
            </h4>
            ${canAct ? `
                <!-- Phase Actions -->
                <div class="space-y-3 mb-6">
                    <button onclick="performGameAction('pass_phase')" 
                            class="w-full bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 hover:border-blue-500 text-blue-300 hover:text-blue-200 py-3 rounded-lg font-semibold transition-all duration-200">
                        ‚è≠Ô∏è Pass Phase
                    </button>
                    <button onclick="performGameAction('draw_card')" 
                            class="w-full bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 hover:border-green-500 text-green-300 hover:text-green-200 py-3 rounded-lg font-semibold transition-all duration-200">
                        üÉè Draw Card
                    </button>
                </div>
                <!-- Quick Actions -->
                <div class="border-t border-arena-accent/30 pt-4">
                    <h5 class="text-arena-accent font-semibold mb-3">Quick Actions</h5>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <button onclick="performGameAction('untap_all')" 
                                class="bg-arena-surface hover:bg-arena-surface-light border border-arena-accent/30 hover:border-arena-accent/50 text-arena-text py-2 rounded">
                            üîÑ Untap All
                        </button>
                        <button onclick="performGameAction('end_turn')" 
                                class="bg-arena-surface hover:bg-arena-surface-light border border-arena-accent/30 hover:border-arena-accent/50 text-arena-text py-2 rounded">
                            ‚è∏Ô∏è End Turn
                        </button>
                    </div>
                </div>
            ` : `
                <!-- Spectator View -->
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">üëÅÔ∏è</div>
                    <h5 class="text-arena-accent font-semibold mb-2">Spectator Mode</h5>
                    <p class="text-arena-text-dim text-sm">You are watching the battle unfold</p>
                </div>
            `}
        `;
    } catch (error) {
        console.error('Error generating action panel:', error);
        actionPanelContainer.innerHTML = `
            <div class="text-center py-4">
                <h5 class="text-red-400 font-bold mb-2">‚ö†Ô∏è Error</h5>
                <p class="text-arena-text-dim text-sm">${error.message}</p>
            </div>
        `;
    }
}

// Helper functions for game actions
function performGameAction(actionType, actionData = {}) {
    console.log(`Performing action: ${actionType}`, actionData);
    
    if (currentSelectedPlayer === 'spectator') {
        showNotification('Spectators cannot perform actions', 'error');
        return;
    }
    
    // Send via WebSocket if available
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        sendGameAction(actionType, actionData);
    } else {
        // Fallback to HTTP request
        performHttpGameAction(actionType, actionData);
    }
}

async function performHttpGameAction(actionType, actionData = {}) {
    try {
        let endpoint;
        let requestData = { player_id: currentSelectedPlayer, ...actionData };
        
        switch (actionType) {
            case 'pass_phase':
            case 'pass_turn':
                endpoint = `/api/v1/games/${gameId}/pass-phase`;
                break;
            case 'draw_card':
                endpoint = `/api/v1/games/${gameId}/draw-card`;
                break;
            case 'play_card':
                endpoint = `/api/v1/games/${gameId}/play-card`;
                break;
            default:
                throw new Error(`Unknown action type: ${actionType}`);
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`Action performed: ${actionType}`, 'success');
                // The WebSocket should handle the state update
            } else {
                showNotification(`Action failed: ${result.error}`, 'error');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('HTTP action error:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

function playCardFromHand(cardId, handIndex) {
    performGameAction('play_card', { 
        card_id: cardId,
        hand_index: handIndex 
    });
}

// Auto-refresh functionality
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    autoRefreshInterval = setInterval(refreshGameData, 5000); // Every 5 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}
</script>
{% endblock %}
