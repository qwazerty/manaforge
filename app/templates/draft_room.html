{% extends "base_arena.html" %}

{% block title %}Draft Room - {{ room.name }}{% endblock %}

{% block content %}
<div id="draft-room-root" class="py-12 px-4" data-room='{{ room | tojson | e }}'>
    <div class="max-w-[1800px] mx-auto">
        <div class="text-center mb-8">
            <h1 class="font-magic text-4xl font-bold text-arena-accent">{{ room.name }}</h1>
            <p class="text-xl text-arena-text-dim">
                Drafting: {{ room.set_name }}
                ({{ room.draft_type | default('draft') | replace('_', ' ') | title }})
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Player List -->
            <div class="lg:col-span-1 arena-card p-4 rounded-lg">
                <h2 class="font-magic text-2xl text-arena-accent mb-4">Players</h2>
                <div id="player-list" class="space-y-2">
                    {% for player in room.players %}
                    <div id="player-{{ player.id }}" class="p-2 bg-arena-surface rounded">
                        {{ player.name }} {% if player.is_bot %}(Bot){% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-4 space-y-2">
                    <button id="add-bot-button" class="arena-button w-full py-4 px-8 rounded-lg">Add Bot</button>
                    <button id="fill-bots-button" class="arena-button w-full py-4 px-8 rounded-lg">Fill with Bots</button>
                    <button id="start-draft-button" class="arena-button w-full py-4 px-8 rounded-lg">Start Draft</button>
                    <div id="export-container" class="mt-4 hidden space-y-3">
                        <div class="flex flex-col gap-2">
                            <button onclick="exportDecklist(event)" class="arena-button w-full py-4 px-8 rounded-lg">Copy Decklist</button>
                        </div>
                        <p id="draft-export-status" class="hidden text-center text-sm text-arena-text-dim"></p>
                    </div>
                </div>
            </div>

            <!-- Main Draft Area -->
            <div class="lg:col-span-3">
                <div id="draft-complete-message" class="hidden text-center p-4 rounded-lg mb-4 arena-card">
                    <h2 class="text-2xl font-bold text-arena-accent">Draft Complete!</h2>
                    <p class="text-arena-text-dim">You can now export your decklist.</p>
                </div>
                <!-- Current Pack -->
                <div id="current-pack-container" class="arena-card p-4 mb-8 rounded-lg">
                    <h2 id="pack-header" class="font-magic text-2xl text-arena-accent mb-4">Current Pack (Pack {{ room.current_pack_number }}, Pick {{ room.current_pick_number }})</h2>
                    <div id="current-pack" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <!-- Cards in the current pack will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Draft Deck Builder -->
        <section id="draft-deck-builder-panel" class="arena-card p-6 rounded-lg space-y-6 mt-10">
            <div class="flex flex-wrap justify-between items-start gap-4">
                <div>
                    <h2 class="font-magic text-2xl text-arena-accent">Draft Deck Builder</h2>
                    <p class="text-sm text-arena-text-dim">Each pick is added automatically. Drag cards between columns while everything auto-saves to your Deck Manager.</p>
                </div>
                <div class="flex flex-wrap gap-2 items-center">
                    <button id="deck-basic-lands-toggle" type="button" class="arena-button px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2">
                        <span>ðŸŒ±</span>Add basic lands
                    </button>
                    <a id="draft-open-deck-builder" href="/decks/builder" class="arena-button px-5 py-2 rounded-lg font-semibold text-sm whitespace-nowrap">
                        Open Full Deck Builder
                    </a>
                </div>
            </div>
            {% set basic_land_previews = [
                {'key': 'plains', 'name': 'Plains', 'mana': 'White mana', 'image': 'https://cards.scryfall.io/normal/front/4/0/4069fb4a-8ee1-41ef-ab93-39a8cc58e0e5.jpg?1755290075'},
                {'key': 'island', 'name': 'Island', 'mana': 'Blue mana', 'image': 'https://cards.scryfall.io/normal/front/a/2/a2e22347-f0cb-4cfd-88a3-4f46a16e4946.jpg?1755290097'},
                {'key': 'swamp', 'name': 'Swamp', 'mana': 'Black mana', 'image': 'https://cards.scryfall.io/normal/front/f/0/f0b234d8-d6bb-48ec-8a4d-d8a570a69c62.jpg?1755290113'},
                {'key': 'mountain', 'name': 'Mountain', 'mana': 'Red mana', 'image': 'https://cards.scryfall.io/normal/front/c/4/c44f81ca-f72f-445c-8901-3a894a2a47f9.jpg?1755290125'},
                {'key': 'forest', 'name': 'Forest', 'mana': 'Green mana', 'image': 'https://cards.scryfall.io/normal/front/a/3/a305e44f-4253-4754-b83f-1e34103d77b0.jpg?1755290142'},
                {'key': 'wastes', 'name': 'Wastes', 'mana': 'Colorless mana', 'image': 'https://cards.scryfall.io/normal/front/b/a/baf8f4f2-9f25-4cd2-8d78-1041e134aeac.jpg?1752945584'}
            ] %}
            <div id="deck-basic-lands-panel" class="hidden rounded-lg border border-arena-accent/20 bg-arena-surface/80 p-4 space-y-4">
                <div class="flex flex-wrap items-start justify-between gap-3">
                    <div>
                        <p class="text-sm text-arena-text">Tap a card to instantly add one copy to your deck. Each land goes straight into the Lands column.</p>
                        <p class="text-xs text-arena-text-dim">Hover any art to reveal the add button.</p>
                    </div>
                    <button id="deck-basic-lands-close" type="button" class="text-sm text-arena-text-dim hover:text-arena-accent">Close âœ•</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3" aria-label="Basic lands gallery">
                    {% for land in basic_land_previews %}
                    <div class="group relative rounded-xl overflow-hidden border border-arena-accent/20 bg-black/40">
                        <img src="{{ land.image }}" alt="{{ land.name }}" class="w-full" style="aspect-ratio: 2 / 3; object-fit: cover;">
                        <button type="button" class="absolute inset-0 hidden group-hover:flex items-center justify-center bg-black/70 text-white text-sm font-semibold transition" data-basic-land-add="{{ land.key }}">
                            Add {{ land.name }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="deck-name-input" class="block text-sm font-semibold text-arena-muted uppercase tracking-wide mb-2">
                        Deck name
                    </label>
                    <input
                        type="text"
                        id="deck-name-input"
                        placeholder="Draft - {{ room.set_name or 'Set' }} - {{ room.name or 'Room' }}"
                        class="w-full px-4 py-3 bg-arena-surface border border-arena-accent/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-arena-accent/30"
                    >
                </div>
                <div>
                    <label for="deck-format-select" class="block text-sm font-semibold text-arena-muted uppercase tracking-wide mb-2">
                        Format
                    </label>
                    <select
                        id="deck-format-select"
                        class="w-full px-4 py-3 bg-arena-surface border border-arena-accent/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-arena-accent/30"
                    >
                        <option value="standard">Standard</option>
                        <option value="modern">Modern</option>
                        <option value="pioneer">Pioneer</option>
                        <option value="pauper">Pauper</option>
                        <option value="legacy">Legacy</option>
                        <option value="vintage">Vintage</option>
                        <option value="duel_commander">Duel Commander</option>
                        <option value="commander_multi">Commander Multi</option>
                        <option value="draft">Draft</option>
                    </select>
                </div>
            </div>
            <div class="grid md:grid-cols-4 gap-4">
                <div class="p-4 bg-arena-surface rounded-lg border border-arena-accent/10 text-center">
                    <p class="text-sm uppercase tracking-wide text-arena-muted">Main deck</p>
                    <p id="deck-main-count" class="text-3xl font-bold text-arena-accent mt-1">0</p>
                </div>
                <div class="p-4 bg-arena-surface rounded-lg border border-arena-accent/10 text-center">
                    <p class="text-sm uppercase tracking-wide text-arena-muted">Sideboard</p>
                    <p id="deck-sideboard-count" class="text-3xl font-bold text-arena-text mt-1">0</p>
                </div>
                <div class="p-4 bg-arena-surface rounded-lg border border-arena-accent/10">
                    <p class="text-sm uppercase tracking-wide text-arena-muted">Colors</p>
                    <div id="deck-color-chips" class="flex flex-wrap gap-2 mt-2 text-sm"></div>
                </div>
                <div class="p-4 bg-arena-surface rounded-lg border border-arena-accent/10">
                    <p class="text-sm uppercase tracking-wide text-arena-muted">Mana curve</p>
                    <div class="h-42 flex items-end" id="deck-mana-curve-bars"></div>
                    <div class="flex justify-between text-xs text-arena-muted mt-2" id="deck-mana-curve-labels"></div>
                </div>
            </div>
            <div>
                <p class="text-sm font-semibold text-arena-muted uppercase tracking-wide mb-2">Type counts</p>
                <div id="deck-type-breakdown" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="deck-columns-panel pb-2 space-y-4">
                <div id="deck-columns"></div>
            </div>
        </section>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/game-utils.js') }}"></script>
<script src="{{ url_for('static', path='js/game-cards.js') }}"></script>
<script src="{{ url_for('static', path='js/card-search.js') }}"></script>
<script src="{{ url_for('static', path='js/deck-library.js') }}"></script>
<script src="{{ url_for('static', path='js/draft-room-context.js') }}"></script>
<script src="{{ url_for('static', path='js/deck-manager.js') }}"></script>
<script src="{{ url_for('static', path='js/draft-room.js') }}"></script>
{% endblock %}
