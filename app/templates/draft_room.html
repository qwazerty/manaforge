{% extends "base_arena.html" %}

{% block title %}Draft Room - {{ room.name }}{% endblock %}

{% block content %}
<div class="py-12 px-4">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="font-magic text-4xl font-bold text-arena-accent">{{ room.name }}</h1>
            <p class="text-xl text-arena-text-dim">Drafting: {{ room.set_name }}</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Player List -->
            <div class="lg:col-span-1 arena-card p-4">
                <h2 class="font-magic text-2xl text-arena-accent mb-4">Players</h2>
                <div id="player-list" class="space-y-2">
                    {% for player in room.players %}
                    <div id="player-{{ player.id }}" class="p-2 bg-arena-surface rounded">
                        {{ player.name }} {% if player.is_bot %}(Bot){% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-4">
                    <button id="add-bot-button" class="arena-button w-full py-2">Add Bot</button>
                    <button id="start-draft-button" class="arena-button w-full py-2 mt-2">Start Draft</button>
                </div>
            </div>

            <!-- Main Draft Area -->
            <div class="lg:col-span-3">
                <!-- Current Pack -->
                <div class="arena-card p-4 mb-8">
                    <h2 class="font-magic text-2xl text-arena-accent mb-4">Current Pack (Pack {{ room.current_pack_number }}, Pick {{ room.current_pick_number }})</h2>
                    <div id="current-pack" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <!-- Cards in the current pack will be rendered here -->
                    </div>
                </div>

                <!-- Drafted Cards -->
                <div class="arena-card p-4">
                    <h2 class="font-magic text-2xl text-arena-accent mb-4">Your Drafted Cards</h2>
                    <div id="drafted-cards" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-4">
                        <!-- Player's drafted cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const roomId = "{{ room.id }}";
    let playerId = localStorage.getItem(`manaforge-player-id-${roomId}`);
    let playerName = localStorage.getItem(`manaforge-player-name-${roomId}`);

    const websocket = new WebSocket(`ws://${window.location.host}/ws/game/${roomId}?player=${playerId}`);

    function renderPack(pack) {
        const packContainer = document.getElementById('current-pack');
        packContainer.innerHTML = pack.map(card => `
            <div class="cursor-pointer" onclick="pickCard('${card.unique_id}')">
                <img src="${card.image_url}" alt="${card.name}" class="rounded-lg w-full">
            </div>
        `).join('');
    }

    function renderDraftedCards(cards) {
        const draftedContainer = document.getElementById('drafted-cards');
        draftedContainer.innerHTML = cards.map(card => `
            <div>
                <img src="${card.image_url}" alt="${card.name}" class="rounded-lg w-full">
            </div>
        `).join('');
    }

    async function pickCard(cardUniqueId) {
        const response = await fetch(`/api/v1/draft/rooms/${roomId}/pick`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                player_id: playerId,
                card_unique_id: cardUniqueId
            })
        });
        if (!response.ok) {
            alert('Failed to pick card.');
        }
    }

    async function joinRoom() {
        if (!playerId) {
            const response = await fetch(`/api/v1/draft/rooms/${roomId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
                const player = await response.json();
                playerId = player.id;
                playerName = player.name;
                localStorage.setItem(`manaforge-player-id-${roomId}`, playerId);
                localStorage.setItem(`manaforge-player-name-${roomId}`, playerName);
            } else {
                alert('Failed to join room.');
                window.location.href = '/draft';
            }
        }
    }
    
    document.getElementById('add-bot-button').addEventListener('click', async () => {
        await fetch(`/api/v1/draft/rooms/${roomId}/add-bot`, { method: 'POST' });
    });

    document.getElementById('start-draft-button').addEventListener('click', async () => {
        await fetch(`/api/v1/draft/rooms/${roomId}/start`, { method: 'POST' });
    });

    websocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'draft_state_update') {
            const room = data.room_state;
            const me = room.players.find(p => p.id === playerId);
            if (me) {
                renderPack(me.current_pack);
                renderDraftedCards(me.drafted_cards);
            }
            // Update player list
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = room.players.map(p => `
                <div id="player-${p.id}" class="p-2 bg-arena-surface rounded ${p.id === playerId ? 'font-bold' : ''}">
                    ${p.name} ${p.is_bot ? '(Bot)' : ''}
                </div>
            `).join('');
        }
    };

    window.addEventListener('load', joinRoom);

</script>
{% endblock %}
